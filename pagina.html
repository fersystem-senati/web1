<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GYM HERCULES - Sistema</title>
  <style>
    :root{
      --wine:#3b0000;
      --wine2:#5a0000;
      --wine3:#7a0000;
      --bg:#ffffff;
      --muted:#eeeeee;
      --muted2:#d9d9d9;
      --text:#1a1a1a;
      --line:#bfbfbf;
      --shadow:0 10px 25px rgba(0,0,0,.18);
      --radius:6px;
      --font: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; font-family:var(--font); color:var(--text); background:#f4f4f4; }

    .app{ height:100%; display:flex; background:var(--bg); }

    /* Sidebar */
    .sidebar{
      width:250px; min-width:250px; color:#fff; position:relative; overflow:hidden;
      background:
        linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.55)),
        linear-gradient(180deg, rgba(90,0,0,.85), rgba(35,0,0,.9)),
        url("img/sidebar-bg.jpg");
      background-size:cover; background-position:center;
      box-shadow: inset -1px 0 0 rgba(255,255,255,.08);
    }
    .brand{ padding:18px 18px 8px; text-align:center; letter-spacing:.5px; font-weight:800; line-height:1.1; }
    .brand .small{ font-weight:700; opacity:.95; }
    .nav{ margin-top:10px; padding:8px 10px; display:flex; flex-direction:column; gap:6px; }
    .nav a{
      display:flex; align-items:center; gap:10px; padding:12px 12px; color:#fff; text-decoration:none;
      border-radius:8px; user-select:none;
      background:rgba(0,0,0,.10);
      border:1px solid rgba(255,255,255,.10);
      transition:transform .15s ease, background .15s ease, border-color .15s ease;
    }
    .nav a:hover{ transform:translateX(2px); background:rgba(0,0,0,.18); border-color:rgba(255,255,255,.18); }
    .nav a.active{ background:rgba(0,0,0,.28); border-color:rgba(255,255,255,.22); }
    .nav .icon{ width:22px; height:22px; display:grid; place-items:center; flex:0 0 22px; }
    .nav .label{ font-size:14px; font-weight:700; opacity:.98; }

    .sidebar .footer{ position:absolute; left:0; right:0; bottom:0; padding:14px 14px 16px; }
    .settings{
      display:flex; align-items:center; gap:10px; padding:12px 12px; border-radius:10px;
      background:rgba(0,0,0,.20); border:1px solid rgba(255,255,255,.14); cursor:pointer;
      font-weight:800;
    }
    .settings:hover{ background:rgba(0,0,0,.28); }

    /* Main */
    .main{ flex:1; display:flex; flex-direction:column; min-width:0; background:#fff; position:relative; }
    .topbar{ display:flex; justify-content:space-between; padding:10px 12px; gap:10px; align-items:center; }
    .topbar .title{
      font-weight:900; letter-spacing:.2px;
      color:#2b2b2b;
      display:flex; align-items:center; gap:10px;
    }
    .badge{
      font-size:12px; font-weight:900;
      padding:4px 10px; border-radius:999px;
      background:#f0f0f0; border:1px solid #d7d7d7;
    }
    .close-btn{
      width:26px; height:22px; border-radius:3px; border:1px solid #8b0000;
      background:#d10000; color:#fff; font-weight:900; cursor:pointer;
      display:grid; place-items:center; box-shadow:0 4px 10px rgba(0,0,0,.18);
    }

    .content{
      padding:0 18px 18px;
      display:grid;
      grid-template-columns: 1fr 190px;
      gap:18px;
      min-height:0;
      height:calc(100% - 44px);
    }

    .page{ display:none; min-height:0; }
    .page.active{ display:block; }

    h2{ margin:0 0 8px; font-size:20px; }

    .section-title{ font-weight:900; margin:10px 0 8px; font-size:13.5px; }
    .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin:6px 0 10px; }
    .row.space{ justify-content:space-between; }
    label{ font-size:12.5px; font-weight:900; margin-right:6px; }

    select, input, textarea{
      height:26px; padding:4px 8px;
      border:1px solid #bdbdbd; border-radius:2px; outline:none;
      font-size:12.5px; background:#fff;
    }
    textarea{ height:auto; min-height:60px; resize:vertical; padding:8px; }
    input:focus, select:focus, textarea:focus{ border-color:#7a0000; box-shadow:0 0 0 2px rgba(122,0,0,.12); }

    .box{ background:var(--muted); border:1px solid var(--line); border-radius:2px; overflow:auto; }
    .box.h145{ height:145px; }
    .box.h170{ height:170px; }
    .divider-line{ height:1px; background:#bdbdbd; margin:10px 0 12px; width:100%; }

    table{ width:100%; border-collapse:collapse; font-size:12.5px; }
    thead th{
      position:sticky; top:0; z-index:1;
      background:#f6f6f6;
      border-bottom:1px solid #cfcfcf;
      text-align:left;
      padding:8px 8px;
      font-weight:900;
    }
    tbody td{ padding:7px 8px; border-bottom:1px solid #dedede; }
    tbody tr{ cursor:pointer; background:transparent; }
    tbody tr:hover{ background:#f2f2f2; }
    tbody tr.selected{ background:rgba(122,0,0,.10); outline:1px solid rgba(122,0,0,.25); }

    .pill{
      display:inline-block; padding:3px 8px; border-radius:999px;
      font-weight:900; font-size:11px;
      border:1px solid #d0d0d0; background:#fff;
    }
    .pill.ok{ border-color:#9fd3a8; background:#eaf7ed; }
    .pill.bad{ border-color:#f0a6a6; background:#ffecec; }
    .pill.warn{ border-color:#f0d5a6; background:#fff6e5; }

    .btn{
      height:26px; padding:0 14px; border-radius:2px;
      border:1px solid #9b9b9b; background:#efefef;
      cursor:pointer; font-weight:900; font-size:12px;
    }
    .btn:hover{ filter:brightness(.98); }
    .btn.primary{ background:var(--wine2); color:#fff; border-color:rgba(255,255,255,.14); }
    .btn.danger{ background:#b00000; color:#fff; border-color:rgba(255,255,255,.14); }
    .btn.ghost{ background:#fff; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .cost{ width:70px; text-align:right; }
    .w240{ width:240px; }
    .w280{ width:280px; }

    /* Right actions */
    .right{
      display:flex; flex-direction:column; gap:12px;
      padding-top:28px; align-items:stretch;
    }
    .mini-btn{
      align-self:flex-end; height:24px; padding:0 10px;
      border-radius:2px; border:1px solid #bdbdbd; background:#efefef;
      cursor:pointer; font-size:12px; font-weight:900;
    }
    .action{
      border-radius:2px; height:92px;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px;
      user-select:none; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.12);
      transition:transform .12s ease, filter .12s ease;
      border:1px solid rgba(255,255,255,.12);
    }
    .action:hover{ transform:translateY(-1px); filter:brightness(.98); }
    .action .big-icon{ width:38px; height:38px; display:grid; place-items:center; opacity:.95; }
    .action .txt{ text-align:center; font-weight:900; letter-spacing:.2px; line-height:1.05; }

    .action.grey{ background:#dcdcdc; color:#555; border-color:#c9c9c9; }
    .action.red{ background:var(--wine2); color:#fff; }
    .action.dark{ background:#4b4b4b; color:#fff; height:120px; margin-top:auto; }

    .action.small{
      height:48px; flex-direction:row; justify-content:center; gap:10px; padding:0 10px;
    }
    .action.small .big-icon{ width:22px; height:22px; }
    .action.small .txt{ font-size:13px; }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center;
      padding:18px;
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      width:min(560px, 96vw);
      background:#fff;
      border-radius:10px;
      box-shadow:0 18px 60px rgba(0,0,0,.28);
      border:1px solid rgba(0,0,0,.08);
      overflow:hidden;
    }
    .modal .m-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      background:#f7f7f7;
      border-bottom:1px solid #e2e2e2;
      font-weight:900;
    }
    .modal .m-body{ padding:14px; }
    .modal .m-foot{
      padding:12px 14px;
      display:flex; justify-content:flex-end; gap:10px;
      border-top:1px solid #eee;
    }

    .notice{
      padding:10px 12px;
      background:#fff6e5;
      border:1px solid #f0d5a6;
      border-radius:8px;
      font-size:12.5px;
      font-weight:800;
    }

    @media (max-width: 980px){
      .content{ grid-template-columns:1fr; }
      .right{ padding-top:0; flex-direction:row; flex-wrap:wrap; justify-content:flex-end; }
      .action{ width:160px; }
      .action.dark{ width:240px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div>GYM</div>
        <div class="small">HERCULES</div>
      </div>

      <nav class="nav">
        <a href="#" data-page="inicio" class="active">
          <span class="icon">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor" aria-hidden="true">
              <path d="M12 3 2.5 11.1l1.3 1.5L5 11.6V21h6v-6h2v6h6v-9.4l1.2 1.0 1.3-1.5L12 3z"/>
            </svg>
          </span>
          <span class="label">Inicio</span>
        </a>

        <a href="#" data-page="registrar">
          <span class="icon">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor" aria-hidden="true">
              <path d="M9 2h6l1 2h3v18H5V4h3l1-2zm1.3 2 .4.8h2.6l.4-.8h-3.4zM7 6v14h10V6H7zm2 3h6v2H9V9zm0 4h6v2H9v-2z"/>
            </svg>
          </span>
          <span class="label">Registrar Cliente</span>
        </a>

        <a href="#" data-page="ventas">
          <span class="icon">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor" aria-hidden="true">
              <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM6.2 6l.7 3h10.6l1.2-4H7.1l-.2-1H3V2h3.6l1.1 4zM7.3 11l.5 2h9.7l.6-2H7.3z"/>
            </svg>
          </span>
          <span class="label">Ventas</span>
        </a>

        <a href="#" data-page="cobrar">
          <span class="icon">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor" aria-hidden="true">
              <path d="M3 6h18v12H3V6zm2 2v8h14V8H5zm7 1c2.2 0 4 1.8 4 4s-1.8 4-4 4-4-1.8-4-4 1.8-4 4-4z"/>
            </svg>
          </span>
          <span class="label">Cuentas por Cobrar</span>
        </a>

        <a href="#" data-page="reportes">
          <span class="icon">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor" aria-hidden="true">
              <path d="M6 2h9l3 3v17H6V2zm2 2v16h8V6h-3V4H8zm1 5h6v2H9V9zm0 4h6v2H9v-2z"/>
            </svg>
          </span>
          <span class="label">Reportes</span>
        </a>
      </nav>

      <div class="footer">
        <div class="settings" id="btnConfig">
          <span class="icon">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor" aria-hidden="true">
              <path d="M19.4 13a7.7 7.7 0 0 0 .1-1l2-1.5-2-3.5-2.4.7a7.2 7.2 0 0 0-1.7-1L15 2h-4l-.4 2.7a7.2 7.2 0 0 0-1.7 1L6.5 5l-2 3.5 2 1.5a7.7 7.7 0 0 0 0 2l-2 1.5 2 3.5 2.4-.7a7.2 7.2 0 0 0 1.7 1L11 22h4l.4-2.7a7.2 7.2 0 0 0 1.7-1l2.4.7 2-3.5-2.1-1.5zM13.9 12a1.9 1.9 0 1 1-3.8 0 1.9 1.9 0 0 1 3.8 0z"/>
            </svg>
          </span>
          <div>Configuración</div>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="title">
          <span id="topTitle">Resumen</span>
          <span class="badge" id="selectedBadge">Sin selección</span>
        </div>
        <button class="close-btn" id="btnClose" title="Cerrar">X</button>
      </div>

      <div class="content">
        <!-- LEFT AREA (PAGES) -->
        <section style="min-width:0; min-height:0;">
          <!-- INICIO / RESUMEN -->
          <div class="page active" id="page-inicio">
            <h2>Resumen:</h2>

            <div class="section-title">Lista de Alumnos:</div>
            <div class="row space">
              <div class="row" style="margin:0;">
                <div class="row" style="margin:0;">
                  <label for="fServicio">Servicio:</label>
                  <select id="fServicio">
                    <option value="">Todos</option>
                    <option value="DIARIO">Diario</option>
                    <option value="SEMANAL">Semanal</option>
                    <option value="MENSUAL">Mensual</option>
                  </select>
                </div>
                <div class="row" style="margin:0;">
                  <label for="fNombre">Nombre:</label>
                  <input id="fNombre" class="w280" type="text" placeholder="Buscar..." />
                </div>
              </div>
              <button class="btn" id="btnNuevoCliente">+ Nuevo Cliente</button>
            </div>

            <div class="box h145">
              <table>
                <thead>
                  <tr>
                    <th style="width:38px;">#</th>
                    <th>Nombre</th>
                    <th style="width:92px;">Servicio</th>
                    <th style="width:120px;">Vence</th>
                    <th style="width:110px;">Estado</th>
                    <th style="width:110px;">Saldo</th>
                  </tr>
                </thead>
                <tbody id="tbClientes"></tbody>
              </table>
            </div>

            <div class="divider-line"></div>

            <div class="section-title">Cuentas por Cobrar:</div>
            <div class="row" style="margin-bottom:8px;">
              <label for="cobNombre">Nombre:</label>
              <input id="cobNombre" class="w240" type="text" placeholder="Filtrar..." />
              <button class="btn" id="btnIrCobrar">Ir a Cobros</button>
            </div>

            <div class="box h170">
              <table>
                <thead>
                  <tr>
                    <th style="width:38px;">#</th>
                    <th>Nombre</th>
                    <th style="width:110px;">Saldo</th>
                    <th style="width:120px;">Últ. pago</th>
                  </tr>
                </thead>
                <tbody id="tbCuentas"></tbody>
              </table>
            </div>

            <div class="divider-line"></div>

            <div class="section-title">Registrar clase por día:</div>
            <div class="row">
              <label for="claseCosto">Costo:</label>
              <input id="claseCosto" class="cost" type="number" min="0" step="0.10" value="5.00" />
              <button class="btn" id="btnClaseCargar">Guardar</button>
              <span class="notice" style="flex:1; min-width:260px;">
                Se carga como <b>deuda</b> al cliente seleccionado (si no hay selección, no se registra).
              </span>
            </div>

          </div>

          <!-- REGISTRAR CLIENTE -->
          <div class="page" id="page-registrar">
            <h2>Registrar Cliente:</h2>

            <div class="row">
              <div class="row" style="margin:0;">
                <label for="rNombre">Nombre:</label>
                <input id="rNombre" class="w280" type="text" placeholder="Ej: Juan Pérez" />
              </div>
              <div class="row" style="margin:0;">
                <label for="rDni">DNI (opcional):</label>
                <input id="rDni" type="text" style="width:140px;" placeholder="8 dígitos" />
              </div>
            </div>

            <div class="row">
              <div class="row" style="margin:0;">
                <label for="rServicio">Servicio:</label>
                <select id="rServicio">
                  <option value="MENSUAL">Mensual</option>
                  <option value="SEMANAL">Semanal</option>
                  <option value="DIARIO">Diario</option>
                </select>
              </div>

              <div class="row" style="margin:0;">
                <label for="rInicio">Inicio:</label>
                <input id="rInicio" type="date" />
              </div>

              <div class="row" style="margin:0;">
                <label for="rPrecio">Precio (S/):</label>
                <input id="rPrecio" type="number" min="0" step="0.10" style="width:120px;" />
              </div>
            </div>

            <div class="row">
              <div class="row" style="margin:0;">
                <label for="rObs">Observación:</label>
                <textarea id="rObs" style="width:min(720px, 100%);" placeholder="Notas del cliente..."></textarea>
              </div>
            </div>

            <div class="row">
              <button class="btn primary" id="btnRegistrarGuardar">Guardar</button>
              <button class="btn" id="btnRegistrarLimpiar">Limpiar</button>
              <button class="btn ghost" id="btnRegistrarVolver">Volver</button>
            </div>

            <div class="divider-line"></div>

            <div class="section-title">Editar Cliente Seleccionado:</div>
            <div class="notice" style="margin-bottom:10px;">
              Selecciona un cliente en <b>Inicio</b> para editar o eliminar aquí.
            </div>

            <div class="row">
              <button class="btn" id="btnEditarCargar">Cargar selección</button>
              <button class="btn danger" id="btnEditarEliminar">Eliminar cliente</button>
            </div>
          </div>

          <!-- VENTAS -->
          <div class="page" id="page-ventas">
            <h2>Ventas:</h2>

            <div class="row space">
              <div class="notice" style="flex:1; min-width:320px;">
                Venta rápida con productos básicos. Se guarda en el historial de ventas.
              </div>
              <button class="btn" id="btnVentaLimpiar">Vaciar carrito</button>
            </div>

            <div class="row">
              <label>Producto:</label>
              <select id="vProducto">
                <option value="AGUA">Agua</option>
                <option value="GATORADE">Gatorade</option>
                <option value="PROTEINA">Proteína (serv.)</option>
                <option value="GUANTES">Guantes</option>
              </select>

              <label>Precio (S/):</label>
              <input id="vPrecio" type="number" min="0" step="0.10" style="width:120px;" />

              <label>Cant.:</label>
              <input id="vCant" type="number" min="1" step="1" value="1" style="width:80px;" />

              <button class="btn primary" id="btnVentaAgregar">Agregar</button>
            </div>

            <div class="section-title">Carrito:</div>
            <div class="box h170">
              <table>
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th style="width:90px;">Cant.</th>
                    <th style="width:120px;">Precio</th>
                    <th style="width:120px;">Subtotal</th>
                    <th style="width:80px;">Acción</th>
                  </tr>
                </thead>
                <tbody id="tbCarrito"></tbody>
              </table>
            </div>

            <div class="row space" style="margin-top:10px;">
              <div class="row" style="margin:0;">
                <label for="vCliente">Cliente (opcional):</label>
                <input id="vCliente" class="w280" type="text" placeholder="Se llena automático si hay selección" />
              </div>
              <div class="row" style="margin:0;">
                <span class="badge" id="ventaTotal">Total: S/ 0.00</span>
                <button class="btn primary" id="btnVentaCobrar">Realizar Venta</button>
              </div>
            </div>

            <div class="divider-line"></div>
            <div class="section-title">Historial (últimas 20):</div>
            <div class="box h170">
              <table>
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th style="width:120px;">Total</th>
                    <th style="width:120px;">Items</th>
                  </tr>
                </thead>
                <tbody id="tbVentasHist"></tbody>
              </table>
            </div>
          </div>

          <!-- COBROS -->
          <div class="page" id="page-cobrar">
            <h2>Cuentas por Cobrar:</h2>

            <div class="row space">
              <div class="row" style="margin:0;">
                <label for="pNombre">Nombre:</label>
                <input id="pNombre" class="w280" type="text" placeholder="Filtrar..." />
              </div>
              <button class="btn" id="btnCobrosIrInicio">Volver a Inicio</button>
            </div>

            <div class="box h170">
              <table>
                <thead>
                  <tr>
                    <th style="width:38px;">#</th>
                    <th>Nombre</th>
                    <th style="width:120px;">Saldo</th>
                    <th style="width:120px;">Últ. pago</th>
                    <th style="width:120px;">Vence</th>
                  </tr>
                </thead>
                <tbody id="tbCobros"></tbody>
              </table>
            </div>

            <div class="divider-line"></div>

            <div class="section-title">Detalle del cliente seleccionado:</div>
            <div class="box" style="padding:10px; background:#fff;">
              <div id="detalleCobro" class="notice" style="background:#f6f6f6; border-color:#e2e2e2;">
                Selecciona un cliente con saldo o un cliente cualquiera desde Inicio.
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn primary" id="btnPagoAbrir">Registrar Pago</button>
              <button class="btn" id="btnRenovarAbrir">Renovar Servicio</button>
              <button class="btn danger" id="btnEliminarAbrir">Eliminar Cliente</button>
            </div>

            <div class="divider-line"></div>
            <div class="section-title">Pagos (últimos 20):</div>
            <div class="box h170">
              <table>
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Método</th>
                    <th style="width:120px;">Monto</th>
                    <th>Nota</th>
                  </tr>
                </thead>
                <tbody id="tbPagos"></tbody>
              </table>
            </div>
          </div>

          <!-- REPORTES -->
          <div class="page" id="page-reportes">
            <h2>Reportes:</h2>

            <div class="row">
              <button class="btn" id="btnReporteActualizar">Actualizar</button>
              <button class="btn" id="btnExportar">Exportar JSON</button>
              <button class="btn danger" id="btnResetDemo">Reset (Borrar datos)</button>
            </div>

            <div class="divider-line"></div>

            <div class="row" style="gap:18px;">
              <div class="notice" style="background:#eaf7ed; border-color:#9fd3a8;">
                <div style="font-weight:900; margin-bottom:6px;">Clientes</div>
                <div id="repClientes">-</div>
              </div>
              <div class="notice" style="background:#fff6e5; border-color:#f0d5a6;">
                <div style="font-weight:900; margin-bottom:6px;">Deudas (S/)</div>
                <div id="repDeudas">-</div>
              </div>
              <div class="notice" style="background:#eef3ff; border-color:#b9c8ff;">
                <div style="font-weight:900; margin-bottom:6px;">Ventas (S/)</div>
                <div id="repVentas">-</div>
              </div>
              <div class="notice" style="background:#ffecec; border-color:#f0a6a6;">
                <div style="font-weight:900; margin-bottom:6px;">Vencidos</div>
                <div id="repVencidos">-</div>
              </div>
            </div>

            <div class="divider-line"></div>

            <div class="section-title">Top deudores (Top 10):</div>
            <div class="box h170">
              <table>
                <thead>
                  <tr>
                    <th>Cliente</th>
                    <th style="width:140px;">Saldo</th>
                    <th style="width:140px;">Vence</th>
                  </tr>
                </thead>
                <tbody id="tbTopDeuda"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- RIGHT ACTIONS (GLOBAL) -->
        <aside class="right">
          <button class="mini-btn" id="btnActualizar">Actualizar</button>

          <div class="action grey" id="btnRenovar" title="Renovar">
            <div class="big-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="40" height="40" fill="currentColor">
                <path d="M17.7 6.3A8 8 0 1 0 20 12h-2a6 6 0 1 1-1.8-4.2L14 10h8V2l-4.3 4.3z"/>
              </svg>
            </div>
            <div class="txt">Renovar</div>
          </div>

          <div class="action red small" id="btnEliminar" title="Eliminar">
            <div class="big-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                <path d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3 1.4 1.4z"/>
              </svg>
            </div>
            <div class="txt">Eliminar</div>
          </div>

          <div class="action red" id="btnPago" title="Registrar Pago">
            <div class="big-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="40" height="40" fill="currentColor">
                <path d="M3 17.3V21h3.7L18.8 8.9l-3.7-3.7L3 17.3zm17.7-10.6a1 1 0 0 0 0-1.4l-2-2a1 1 0 0 0-1.4 0l-1.6 1.6 3.7 3.7 1.3-1.9z"/>
              </svg>
            </div>
            <div class="txt">Registrar<br>Pago</div>
          </div>

          <div class="action dark" id="btnVenta" title="Realizar Venta">
            <div class="big-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="44" height="44" fill="currentColor">
                <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM6.2 6l.7 3h10.6l1.2-4H7.1l-.2-1H3V2h3.6l1.1 4zM7.3 11l.5 2h9.7l.6-2H7.3z"/>
              </svg>
            </div>
            <div class="txt">Realizar<br>Venta</div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <!-- MODALS -->
  <div class="modal-backdrop" id="modalPago">
    <div class="modal">
      <div class="m-head">
        <div>Registrar Pago</div>
        <button class="btn" id="mPagoCerrar">Cerrar</button>
      </div>
      <div class="m-body">
        <div class="notice" style="background:#f6f6f6; border-color:#e2e2e2;" id="mPagoCliente">Cliente: -</div>

        <div class="row" style="margin-top:10px;">
          <label for="mPagoMonto">Monto (S/):</label>
          <input id="mPagoMonto" type="number" min="0" step="0.10" style="width:140px;" />
          <label for="mPagoMetodo">Método:</label>
          <select id="mPagoMetodo">
            <option value="EFECTIVO">Efectivo</option>
            <option value="YAPE">Yape</option>
            <option value="PLIN">Plin</option>
            <option value="TRANSFERENCIA">Transferencia</option>
          </select>
        </div>

        <div class="row">
          <label for="mPagoNota">Nota:</label>
          <input id="mPagoNota" type="text" style="width:min(420px, 100%);" placeholder="Opcional..." />
        </div>

        <div class="notice" style="margin-top:8px;">
          El pago reduce el <b>saldo</b> (deuda). Si el saldo llega a 0, el cliente queda sin deuda.
        </div>
      </div>
      <div class="m-foot">
        <button class="btn primary" id="mPagoGuardar">Guardar</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalRenovar">
    <div class="modal">
      <div class="m-head">
        <div>Renovar Servicio</div>
        <button class="btn" id="mRenCerrar">Cerrar</button>
      </div>
      <div class="m-body">
        <div class="notice" style="background:#f6f6f6; border-color:#e2e2e2;" id="mRenCliente">Cliente: -</div>

        <div class="row" style="margin-top:10px;">
          <label for="mRenServicio">Servicio:</label>
          <select id="mRenServicio">
            <option value="MENSUAL">Mensual</option>
            <option value="SEMANAL">Semanal</option>
            <option value="DIARIO">Diario</option>
          </select>

          <label for="mRenInicio">Inicio:</label>
          <input id="mRenInicio" type="date" />

          <label for="mRenPrecio">Precio (S/):</label>
          <input id="mRenPrecio" type="number" min="0" step="0.10" style="width:120px;" />
        </div>

        <div class="notice" style="margin-top:8px;">
          La renovación actualiza fecha de vencimiento y suma el precio como <b>cargo</b> (deuda). Luego puedes registrar pago.
        </div>
      </div>
      <div class="m-foot">
        <button class="btn primary" id="mRenGuardar">Renovar</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     *  UTILIDADES
     ***********************/
    const $ = (id) => document.getElementById(id);
    const LS_KEY = "gym_hercules_v1";

    const money = (n) => `S/ ${Number(n || 0).toFixed(2)}`;
    const todayISO = () => new Date().toISOString().slice(0,10);
    const pad2 = (n) => String(n).padStart(2,"0");
    const fmtDate = (iso) => {
      if(!iso) return "-";
      const d = new Date(iso + "T00:00:00");
      return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
    };
    const addDaysISO = (iso, days) => {
      const d = new Date(iso + "T00:00:00");
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0,10);
    };
    const daysByService = (svc) => ({ DIARIO: 1, SEMANAL: 7, MENSUAL: 30 }[svc] || 30);
    const defaultPriceByService = (svc) => ({ DIARIO: 5.00, SEMANAL: 25.00, MENSUAL: 70.00 }[svc] ?? 70.00);
    const upper = (s) => String(s || "").trim().toUpperCase();

    function uid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    /***********************
     *  ESTADO (DB)
     ***********************/
    let db = {
      clients: [],
      sales: []
    };

    let selectedClientId = null;

    function loadDB(){
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        try{ db = JSON.parse(raw); }
        catch{ /* ignore */ }
      }
      if(!db || !Array.isArray(db.clients)) db = { clients: [], sales: [] };

      // Seed demo si está vacío
      if(db.clients.length === 0){
        const start = todayISO();
        const c1 = makeClient({name:"Carlos Torres", dni:"", service:"MENSUAL", startDate:start, price:70, obs:""});
        const c2 = makeClient({name:"María López", dni:"", service:"SEMANAL", startDate:start, price:25, obs:""});
        c2.balance = 10; // deuda demo
        c2.payments.push({ id:uid(), date: new Date().toISOString(), amount:15, method:"EFECTIVO", note:"Pago parcial" });
        db.clients.push(c1, c2);
        db.sales.push({
          id: uid(),
          date: new Date().toISOString(),
          clientName: "Carlos Torres",
          total: 8,
          items: [{name:"Agua", qty:2, price:2, subtotal:4},{name:"Gatorade", qty:1, price:4, subtotal:4}]
        });
        saveDB();
      }
    }

    function saveDB(){
      localStorage.setItem(LS_KEY, JSON.stringify(db));
    }

    function makeClient({name, dni, service, startDate, price, obs}){
      const start = startDate || todayISO();
      const end = addDaysISO(start, daysByService(service));
      return {
        id: uid(),
        name: String(name || "").trim(),
        dni: String(dni || "").trim(),
        service: service,
        startDate: start,
        endDate: end,
        price: Number(price || 0),
        balance: Number(price || 0), // se crea como deuda (cargo) por el servicio
        obs: String(obs || "").trim(),
        createdAt: new Date().toISOString(),
        payments: [],
        charges: [] // cargos extra (clases por día, etc.)
      };
    }

    function getClient(id){
      return db.clients.find(c => c.id === id) || null;
    }

    function getStatus(client){
      const now = new Date(todayISO() + "T00:00:00");
      const end = new Date(client.endDate + "T00:00:00");
      if(end < now) return { txt:"Vencido", cls:"bad" };
      const diff = Math.ceil((end - now) / 86400000);
      if(diff <= 3) return { txt:"Por vencer", cls:"warn" };
      return { txt:"Activo", cls:"ok" };
    }

    function setSelected(id){
      selectedClientId = id;
      const c = getClient(id);
      $("selectedBadge").textContent = c ? `Seleccionado: ${c.name}` : "Sin selección";
      // sincronizar venta cliente
      if($("vCliente")) $("vCliente").value = c ? c.name : "";
      renderAll();
    }

    /***********************
     *  NAVEGACIÓN
     ***********************/
    function goPage(pageKey){
      document.querySelectorAll(".nav a").forEach(a => {
        a.classList.toggle("active", a.dataset.page === pageKey);
      });
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      const target = $("page-" + pageKey);
      if(target) target.classList.add("active");

      const titles = {
        inicio:"Resumen",
        registrar:"Registrar Cliente",
        ventas:"Ventas",
        cobrar:"Cuentas por Cobrar",
        reportes:"Reportes"
      };
      $("topTitle").textContent = titles[pageKey] || "Sistema";
      renderAll();
    }

    /***********************
     *  RENDER
     ***********************/
    function renderClientsTable(){
      const svc = $("fServicio") ? $("fServicio").value : "";
      const q = $("fNombre") ? $("fNombre").value.trim().toLowerCase() : "";

      const rows = db.clients
        .slice()
        .sort((a,b) => a.name.localeCompare(b.name))
        .filter(c => !svc || c.service === svc)
        .filter(c => !q || c.name.toLowerCase().includes(q));

      const tb = $("tbClientes");
      if(!tb) return;

      tb.innerHTML = rows.map((c, i) => {
        const st = getStatus(c);
        const sel = c.id === selectedClientId ? "selected" : "";
        return `
          <tr class="${sel}" data-id="${c.id}">
            <td>${i+1}</td>
            <td><b>${escapeHtml(c.name)}</b></td>
            <td>${labelService(c.service)}</td>
            <td>${fmtDate(c.endDate)}</td>
            <td><span class="pill ${st.cls}">${st.txt}</span></td>
            <td>${money(c.balance)}</td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="6" style="padding:12px;">No hay clientes.</td></tr>`;

      tb.querySelectorAll("tr[data-id]").forEach(tr => {
        tr.addEventListener("click", () => setSelected(tr.dataset.id));
      });
    }

    function renderCuentasMini(){
      const q = $("cobNombre") ? $("cobNombre").value.trim().toLowerCase() : "";
      const rows = db.clients
        .filter(c => Number(c.balance) > 0)
        .filter(c => !q || c.name.toLowerCase().includes(q))
        .slice()
        .sort((a,b) => b.balance - a.balance)
        .slice(0, 50);

      const tb = $("tbCuentas");
      if(!tb) return;

      tb.innerHTML = rows.map((c, i) => {
        const last = lastPayment(c);
        const sel = c.id === selectedClientId ? "selected" : "";
        return `
          <tr class="${sel}" data-id="${c.id}">
            <td>${i+1}</td>
            <td><b>${escapeHtml(c.name)}</b></td>
            <td>${money(c.balance)}</td>
            <td>${last ? fmtDate(last.date.slice(0,10)) : "-"}</td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="4" style="padding:12px;">No hay deudas.</td></tr>`;

      tb.querySelectorAll("tr[data-id]").forEach(tr => {
        tr.addEventListener("click", () => setSelected(tr.dataset.id));
      });
    }

    function renderCobrosTable(){
      const q = $("pNombre") ? $("pNombre").value.trim().toLowerCase() : "";
      const rows = db.clients
        .filter(c => !q || c.name.toLowerCase().includes(q))
        .slice()
        .sort((a,b) => (b.balance - a.balance) || a.name.localeCompare(b.name));

      const tb = $("tbCobros");
      if(!tb) return;

      tb.innerHTML = rows.map((c, i) => {
        const last = lastPayment(c);
        const sel = c.id === selectedClientId ? "selected" : "";
        return `
          <tr class="${sel}" data-id="${c.id}">
            <td>${i+1}</td>
            <td><b>${escapeHtml(c.name)}</b></td>
            <td>${money(c.balance)}</td>
            <td>${last ? fmtDate(last.date.slice(0,10)) : "-"}</td>
            <td>${fmtDate(c.endDate)}</td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="5" style="padding:12px;">No hay clientes.</td></tr>`;

      tb.querySelectorAll("tr[data-id]").forEach(tr => {
        tr.addEventListener("click", () => setSelected(tr.dataset.id));
      });
    }

    function renderDetalleCobro(){
      const box = $("detalleCobro");
      const tb = $("tbPagos");
      const c = selectedClientId ? getClient(selectedClientId) : null;

      if(box){
        if(!c){
          box.innerHTML = `Selecciona un cliente para ver detalle.`;
        } else {
          const st = getStatus(c);
          box.innerHTML = `
            <div><b>Cliente:</b> ${escapeHtml(c.name)} ${c.dni ? `(DNI: ${escapeHtml(c.dni)})` : ""}</div>
            <div style="margin-top:6px;">
              <b>Servicio:</b> ${labelService(c.service)} &nbsp;|&nbsp;
              <b>Vence:</b> ${fmtDate(c.endDate)} &nbsp;|&nbsp;
              <b>Estado:</b> <span class="pill ${st.cls}">${st.txt}</span>
            </div>
            <div style="margin-top:6px;">
              <b>Saldo:</b> ${money(c.balance)} &nbsp;|&nbsp;
              <b>Cargos extra:</b> ${money(sumCharges(c))}
            </div>
            ${c.obs ? `<div style="margin-top:6px;"><b>Obs:</b> ${escapeHtml(c.obs)}</div>` : ""}
          `;
        }
      }

      if(tb){
        if(!c){
          tb.innerHTML = `<tr><td colspan="4" style="padding:12px;">Sin selección.</td></tr>`;
        } else {
          const rows = (c.payments || []).slice().sort((a,b)=> b.date.localeCompare(a.date)).slice(0,20);
          tb.innerHTML = rows.map(p => `
            <tr>
              <td>${fmtDate(p.date.slice(0,10))}</td>
              <td>${escapeHtml(p.method)}</td>
              <td>${money(p.amount)}</td>
              <td>${escapeHtml(p.note || "")}</td>
            </tr>
          `).join("") || `<tr><td colspan="4" style="padding:12px;">Sin pagos registrados.</td></tr>`;
        }
      }
    }

    function renderVentas(){
      const tb = $("tbCarrito");
      if(tb){
        tb.innerHTML = cart.items.map((it, idx) => `
          <tr>
            <td>${escapeHtml(it.name)}</td>
            <td>${it.qty}</td>
            <td>${money(it.price)}</td>
            <td>${money(it.subtotal)}</td>
            <td><button class="btn" data-del="${idx}">Quitar</button></td>
          </tr>
        `).join("") || `<tr><td colspan="5" style="padding:12px;">Carrito vacío.</td></tr>`;

        tb.querySelectorAll("button[data-del]").forEach(b=>{
          b.addEventListener("click", () => {
            cart.items.splice(Number(b.dataset.del), 1);
            renderVentas();
          });
        });
      }
      $("ventaTotal").textContent = `Total: ${money(cartTotal())}`;

      const hist = $("tbVentasHist");
      if(hist){
        const rows = db.sales.slice().sort((a,b)=> b.date.localeCompare(a.date)).slice(0,20);
        hist.innerHTML = rows.map(s => `
          <tr>
            <td>${fmtDate(s.date.slice(0,10))}</td>
            <td>${escapeHtml(s.clientName || "-")}</td>
            <td>${money(s.total)}</td>
            <td>${(s.items || []).length}</td>
          </tr>
        `).join("") || `<tr><td colspan="4" style="padding:12px;">Sin ventas registradas.</td></tr>`;
      }
    }

    function renderReportes(){
      const totalClients = db.clients.length;
      const totalDebt = db.clients.reduce((acc,c)=> acc + Number(c.balance||0), 0);
      const totalSales = db.sales.reduce((acc,s)=> acc + Number(s.total||0), 0);
      const vencidos = db.clients.filter(c => getStatus(c).cls === "bad").length;

      if($("repClientes")) $("repClientes").textContent = totalClients;
      if($("repDeudas")) $("repDeudas").textContent = money(totalDebt);
      if($("repVentas")) $("repVentas").textContent = money(totalSales);
      if($("repVencidos")) $("repVencidos").textContent = vencidos;

      const top = db.clients
        .filter(c => Number(c.balance) > 0)
        .slice()
        .sort((a,b)=> b.balance - a.balance)
        .slice(0,10);

      const tb = $("tbTopDeuda");
      if(tb){
        tb.innerHTML = top.map(c => `
          <tr>
            <td><b>${escapeHtml(c.name)}</b></td>
            <td>${money(c.balance)}</td>
            <td>${fmtDate(c.endDate)}</td>
          </tr>
        `).join("") || `<tr><td colspan="3" style="padding:12px;">Sin deudas.</td></tr>`;
      }
    }

    function renderAll(){
      renderClientsTable();
      renderCuentasMini();
      renderCobrosTable();
      renderDetalleCobro();
      renderVentas();
      renderReportes();
      refreshActionButtons();
    }

    function refreshActionButtons(){
      const hasSel = !!selectedClientId && !!getClient(selectedClientId);
      $("btnRenovar").style.opacity = hasSel ? "1" : ".55";
      $("btnEliminar").style.opacity = hasSel ? "1" : ".55";
      $("btnPago").style.opacity = hasSel ? "1" : ".55";
      $("btnRenovar").style.pointerEvents = hasSel ? "auto" : "none";
      $("btnEliminar").style.pointerEvents = hasSel ? "auto" : "none";
      $("btnPago").style.pointerEvents = hasSel ? "auto" : "none";
    }

    function labelService(svc){
      return ({ DIARIO:"Diario", SEMANAL:"Semanal", MENSUAL:"Mensual" }[svc] || svc);
    }

    function lastPayment(c){
      const arr = (c.payments || []);
      if(arr.length === 0) return null;
      return arr.slice().sort((a,b)=> b.date.localeCompare(a.date))[0];
    }

    function sumCharges(c){
      return (c.charges || []).reduce((acc,x)=> acc + Number(x.amount||0), 0);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /***********************
     *  ACCIONES CLIENTES
     ***********************/
    function addClientFromForm(){
      const name = $("rNombre").value.trim();
      const dni = $("rDni").value.trim();
      const service = $("rServicio").value;
      const startDate = $("rInicio").value || todayISO();
      const price = Number($("rPrecio").value || 0);
      const obs = $("rObs").value.trim();

      if(!name){
        alert("Ingresa el nombre del cliente.");
        $("rNombre").focus();
        return;
      }
      if(price < 0){
        alert("Precio inválido.");
        return;
      }

      const c = makeClient({ name, dni, service, startDate, price, obs });
      db.clients.push(c);
      saveDB();

      setSelected(c.id);
      alert("Cliente registrado.");
      clearRegisterForm();
      goPage("inicio");
    }

    function clearRegisterForm(){
      $("rNombre").value = "";
      $("rDni").value = "";
      $("rServicio").value = "MENSUAL";
      $("rInicio").value = todayISO();
      $("rPrecio").value = defaultPriceByService("MENSUAL").toFixed(2);
      $("rObs").value = "";
    }

    function loadSelectionIntoRegister(){
      const c = selectedClientId ? getClient(selectedClientId) : null;
      if(!c){ alert("No hay cliente seleccionado."); return; }

      $("rNombre").value = c.name;
      $("rDni").value = c.dni || "";
      $("rServicio").value = c.service;
      $("rInicio").value = c.startDate;
      $("rPrecio").value = Number(c.price || 0).toFixed(2);
      $("rObs").value = c.obs || "";

      const ok = confirm("¿Quieres actualizar este cliente con los datos del formulario al guardar?");
      if(ok){
        // Guardar como edición (no crear nuevo)
        $("btnRegistrarGuardar").dataset.mode = "edit";
        $("btnRegistrarGuardar").textContent = "Actualizar";
      } else {
        $("btnRegistrarGuardar").dataset.mode = "new";
        $("btnRegistrarGuardar").textContent = "Guardar";
      }
    }

    function updateSelectedFromForm(){
      const c = selectedClientId ? getClient(selectedClientId) : null;
      if(!c){ alert("No hay cliente seleccionado."); return; }

      const name = $("rNombre").value.trim();
      const dni = $("rDni").value.trim();
      const service = $("rServicio").value;
      const startDate = $("rInicio").value || c.startDate;
      const price = Number($("rPrecio").value || 0);
      const obs = $("rObs").value.trim();

      if(!name){
        alert("Ingresa el nombre del cliente.");
        return;
      }

      // Mantener balance actual, pero actualizar servicio/fechas y precio base
      c.name = name;
      c.dni = dni;
      c.service = service;
      c.startDate = startDate;
      c.endDate = addDaysISO(startDate, daysByService(service));
      c.price = price;
      c.obs = obs;

      saveDB();
      alert("Cliente actualizado.");
      $("btnRegistrarGuardar").dataset.mode = "new";
      $("btnRegistrarGuardar").textContent = "Guardar";
      goPage("inicio");
    }

    function deleteSelectedClient(){
      const c = selectedClientId ? getClient(selectedClientId) : null;
      if(!c){ alert("No hay cliente seleccionado."); return; }
      const ok = confirm(`¿Eliminar a "${c.name}"? Esta acción no se puede deshacer.`);
      if(!ok) return;

      db.clients = db.clients.filter(x => x.id !== c.id);
      selectedClientId = null;
      saveDB();
      alert("Cliente eliminado.");
      renderAll();
    }

    function chargeDailyClass(){
      const c = selectedClientId ? getClient(selectedClientId) : null;
      if(!c){ alert("Selecciona un cliente primero."); return; }
      const amount = Number($("claseCosto").value || 0);
      if(amount <= 0){ alert("Costo inválido."); return; }

      const ch = { id: uid(), date: new Date().toISOString(), type:"CLASE_DIARIA", amount };
      c.charges = c.charges || [];
      c.charges.push(ch);
      c.balance = Number(c.balance || 0) + amount;
      saveDB();
      alert("Clase registrada (cargo agregado al saldo).");
      renderAll();
    }

    /***********************
     *  PAGOS
     ***********************/
    function openPagoModal(){
      const c = selectedClientId ? getClient(selectedClientId) : null;
      if(!c){ alert("Selecciona un cliente."); return; }
      $("mPagoCliente").textContent = `Cliente: ${c.name} | Saldo: ${money(c.balance)}`;
      $("mPagoMonto").value = "";
      $("mPagoMetodo").value = "EFECTIVO";
      $("mPagoNota").value = "";
      $("modalPago").classList.add("show");
      $("mPagoMonto").focus();
    }

    function savePago(){
      const c = selectedClientId ? getClient(selectedClientId) : null;
      if(!c){ alert("Sin cliente seleccionado."); return; }
      const amount = Number($("mPagoMonto").value || 0);
      if(amount <= 0){ alert("Monto inválido."); return; }

      const method = $("mPagoMetodo").value;
      const note = $("mPagoNota").value.trim();

      c.payments = c.payments || [];
      c.payments.push({ id: uid(), date: new Date().toISOString(), amount, method, note });

      c.balance = Math.max(0, Number(c.balance || 0) - amount);

      saveDB();
      $("modalPago").classList.remove("show");
      renderAll();
      alert("Pago registrado.");
    }

    /***********************
     *  RENOVACIÓN
     ***********************/
    function openRenovarModal(){
      const c = selectedClientId ? getClient(selectedClientId) : null;
      if(!c){ alert("Selecciona un cliente."); return; }

      $("mRenCliente").textContent = `Cliente: ${c.name} | Vence: ${fmtDate(c.endDate)}`;
      $("mRenServicio").value = c.service || "MENSUAL";
      $("mRenInicio").value = todayISO();
      $("mRenPrecio").value = defaultPriceByService($("mRenServicio").value).toFixed(2);
      $("modalRenovar").classList.add("show");
    }

    function saveRenovar(){
      const c = selectedClientId ? getClient(selectedClientId) : null;
      if(!c){ alert("Sin cliente seleccionado."); return; }

      const service = $("mRenServicio").value;
      const startDate = $("mRenInicio").value || todayISO();
      const price = Number($("mRenPrecio").value || 0);

      if(price <= 0){ alert("Precio inválido."); return; }

      c.service = service;
      c.startDate = startDate;
      c.endDate = addDaysISO(startDate, daysByService(service));
      c.price = price;

      // Cargo de renovación (a deuda)
      c.balance = Number(c.balance || 0) + price;

      // Registrar cargo
      c.charges = c.charges || [];
      c.charges.push({ id: uid(), date: new Date().toISOString(), type:"RENOVACION", amount: price });

      saveDB();
      $("modalRenovar").classList.remove("show");
      renderAll();
      alert("Servicio renovado (cargo agregado al saldo).");
    }

    /***********************
     *  VENTAS
     ***********************/
    const cart = { items: [] };

    function cartTotal(){
      return cart.items.reduce((acc,it)=> acc + Number(it.subtotal||0), 0);
    }

    function setProductDefaults(){
      const map = { AGUA:2.00, GATORADE:4.00, PROTEINA:6.00, GUANTES:15.00 };
      const key = $("vProducto").value;
      $("vPrecio").value = (map[key] ?? 0).toFixed(2);
    }

    function addToCart(){
      const nameKey = $("vProducto").value;
      const name = ({AGUA:"Agua", GATORADE:"Gatorade", PROTEINA:"Proteína (serv.)", GUANTES:"Guantes"}[nameKey]) || nameKey;
      const price = Number($("vPrecio").value || 0);
      const qty = Number($("vCant").value || 1);

      if(price <= 0 || qty <= 0){
        alert("Precio o cantidad inválida.");
        return;
      }
      cart.items.push({ name, price, qty, subtotal: price*qty });
      renderVentas();
    }

    function clearCart(){
      cart.items = [];
      renderVentas();
    }

    function finalizeSale(){
      if(cart.items.length === 0){
        alert("Carrito vacío.");
        return;
      }
      const total = cartTotal();
      const clientName = ($("vCliente").value || "").trim() || (selectedClientId ? (getClient(selectedClientId)?.name || "") : "");

      db.sales.push({
        id: uid(),
        date: new Date().toISOString(),
        clientName,
        total,
        items: cart.items.map(x => ({...x}))
      });
      saveDB();
      clearCart();
      alert("Venta registrada.");
      renderAll();
    }

    /***********************
     *  EXPORT / RESET
     ***********************/
    function exportJSON(){
      const data = JSON.stringify(db, null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `gym_hercules_export_${todayISO()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function resetAll(){
      const ok = confirm("¿Borrar TODOS los datos? (Clientes, pagos, ventas).");
      if(!ok) return;
      localStorage.removeItem(LS_KEY);
      db = { clients: [], sales: [] };
      selectedClientId = null;
      loadDB();
      renderAll();
      alert("Datos reseteados.");
    }

    /***********************
     *  EVENTOS UI
     ***********************/
    function wireUI(){
      // Nav
      document.querySelectorAll(".nav a").forEach(a=>{
        a.addEventListener("click", (e)=>{
          e.preventDefault();
          goPage(a.dataset.page);
        });
      });

      // Top buttons
      $("btnClose").addEventListener("click", ()=> alert("Cerrar ventana (demo web)."));

      $("btnActualizar").addEventListener("click", ()=> renderAll());

      // Inicio
      $("fServicio").addEventListener("change", renderClientsTable);
      $("fNombre").addEventListener("input", renderClientsTable);
      $("cobNombre").addEventListener("input", renderCuentasMini);

      $("btnNuevoCliente").addEventListener("click", ()=>{
        clearRegisterForm();
        $("btnRegistrarGuardar").dataset.mode = "new";
        $("btnRegistrarGuardar").textContent = "Guardar";
        goPage("registrar");
      });

      $("btnIrCobrar").addEventListener("click", ()=> goPage("cobrar"));

      $("btnClaseCargar").addEventListener("click", chargeDailyClass);

      // Registrar
      $("rServicio").addEventListener("change", ()=>{
        const svc = $("rServicio").value;
        $("rPrecio").value = defaultPriceByService(svc).toFixed(2);
        if(!$("rInicio").value) $("rInicio").value = todayISO();
      });

      $("btnRegistrarGuardar").addEventListener("click", ()=>{
        const mode = $("btnRegistrarGuardar").dataset.mode || "new";
        if(mode === "edit") updateSelectedFromForm();
        else addClientFromForm();
      });

      $("btnRegistrarLimpiar").addEventListener("click", clearRegisterForm);
      $("btnRegistrarVolver").addEventListener("click", ()=> goPage("inicio"));
      $("btnEditarCargar").addEventListener("click", loadSelectionIntoRegister);
      $("btnEditarEliminar").addEventListener("click", deleteSelectedClient);

      // Cobros
      $("pNombre").addEventListener("input", renderCobrosTable);
      $("btnCobrosIrInicio").addEventListener("click", ()=> goPage("inicio"));

      $("btnPagoAbrir").addEventListener("click", openPagoModal);
      $("btnRenovarAbrir").addEventListener("click", openRenovarModal);
      $("btnEliminarAbrir").addEventListener("click", deleteSelectedClient);

      // Acciones derecha (global)
      $("btnPago").addEventListener("click", openPagoModal);
      $("btnRenovar").addEventListener("click", openRenovarModal);
      $("btnEliminar").addEventListener("click", deleteSelectedClient);
      $("btnVenta").addEventListener("click", ()=> goPage("ventas"));

      // Modal pago
      $("mPagoCerrar").addEventListener("click", ()=> $("modalPago").classList.remove("show"));
      $("mPagoGuardar").addEventListener("click", savePago);
      $("modalPago").addEventListener("click", (e)=>{
        if(e.target === $("modalPago")) $("modalPago").classList.remove("show");
      });

      // Modal renovar
      $("mRenCerrar").addEventListener("click", ()=> $("modalRenovar").classList.remove("show"));
      $("mRenServicio").addEventListener("change", ()=>{
        $("mRenPrecio").value = defaultPriceByService($("mRenServicio").value).toFixed(2);
      });
      $("mRenGuardar").addEventListener("click", saveRenovar);
      $("modalRenovar").addEventListener("click", (e)=>{
        if(e.target === $("modalRenovar")) $("modalRenovar").classList.remove("show");
      });

      // Ventas
      $("vProducto").addEventListener("change", setProductDefaults);
      $("btnVentaAgregar").addEventListener("click", addToCart);
      $("btnVentaLimpiar").addEventListener("click", clearCart);
      $("btnVentaCobrar").addEventListener("click", finalizeSale);

      // Reportes
      $("btnReporteActualizar").addEventListener("click", renderReportes);
      $("btnExportar").addEventListener("click", exportJSON);
      $("btnResetDemo").addEventListener("click", resetAll);

      // Config
      $("btnConfig").addEventListener("click", ()=>{
        alert("Config (demo): En un sistema real aquí irían usuarios/roles, precios por servicio, backups, etc.");
      });

      // Atajos: Enter en búsqueda
      $("fNombre").addEventListener("keydown", (e)=>{ if(e.key==="Enter") renderClientsTable(); });
      $("pNombre").addEventListener("keydown", (e)=>{ if(e.key==="Enter") renderCobrosTable(); });

      // iniciales
      $("rInicio").value = todayISO();
      clearRegisterForm();
      $("mRenInicio").value = todayISO();
      setProductDefaults();
    }

    /***********************
     *  INIT
     ***********************/
    loadDB();
    wireUI();
    renderAll();

    // Si hay 1er cliente, seleccionar por defecto
    if(db.clients[0]) setSelected(db.clients[0].id);
  </script>
</body>
</html>
